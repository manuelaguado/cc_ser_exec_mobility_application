var indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,dataBase=null,version_bd="CC17v1";$("#allow_update").html(version_bd);
function startDB(){dataBase=indexedDB.open("serexecutive3",1);dataBase.onupgradeneeded=function(a){a=dataBase.result;var b=a.createObjectStore("claves",{keyPath:"id",autoIncrement:!0});b.createIndex("by_iden","id",{unique:!0});b.createIndex("by_token","token",{unique:!0});a.createObjectStore("page",{keyPath:"id",autoIncrement:!0}).createIndex("by_iden","iden",{unique:!0});b=a.createObjectStore("viaje",{keyPath:"id",autoIncrement:!0});b.createIndex("by_id_viaje","id_viaje",{unique:!0});b.createIndex("by_iden",
"iden",{unique:!0});a.createObjectStore("state_boton",{keyPath:"id",autoIncrement:!0}).createIndex("by_iden","iden",{unique:!0});a.createObjectStore("estados_variables",{keyPath:"id",autoIncrement:!0}).createIndex("by_iden","iden",{unique:!0});b=a.createObjectStore("gps",{keyPath:"id",autoIncrement:!0});b.createIndex("by_iden","id",{unique:!0});b.createIndex("by_token","token",{unique:!0});a.createObjectStore("cordon",{keyPath:"id",autoIncrement:!0}).createIndex("by_iden","iden",{unique:!0});a.createObjectStore("ride",
{keyPath:"id",autoIncrement:!0}).createIndex("by_iden","iden",{unique:!0})};dataBase.onsuccess=function(a){2==mvhc?mvhc_start():setStartPage()};dataBase.onerror=function(a){alert("Error loading database")}}function getRide(){var a=dataBase.result.transaction(["ride"],"readwrite").objectStore("ride").index("by_iden").get(1);a.onsuccess=function(){var b=a.result;void 0!==b&&print_travel(b.ride)}}
function storageRide(a,b){var c=dataBase.result.transaction(["ride"],"readwrite").objectStore("ride"),d=c.index("by_iden").get(1);c.clear();d.onsuccess=function(){c.put({iden:1,ride:a});b()}}function deleteRide(a){var b=dataBase.result.transaction(["ride"],"readwrite").objectStore("ride");b.index("by_iden").get(1);b.clear();a()}
function getCordon(){var a=dataBase.result.transaction(["cordon"],"readwrite").objectStore("cordon").index("by_iden").get(1);a.onsuccess=function(){setCordonDual(a.result.cordon)}}function storageCordon(a,b){var c=dataBase.result.transaction(["cordon"],"readwrite").objectStore("cordon"),d=c.index("by_iden").get(1);c.clear();d.onsuccess=function(){c.put({iden:1,cordon:a});b()}}
function setStartPage(){var a=dataBase.result.transaction(["page"],"readwrite").objectStore("page").index("by_iden").get(1);a.onsuccess=function(){var b=a.result;void 0!==b?"regreso_init"==b.actual?initEpisodioAuto():(eval("html = myApp."+b.actual+"({origen: '"+b.origen+"' })"),mainView.loadContent(""),"base"!==b.actual&&getRide(),"base"!==b.actual?loadStateBoton():getCordon()):initEpisodioAuto()}}
function setStoreVariable(a,b,c){b=dataBase.result.transaction(["estados_variables"],"readwrite").objectStore("estados_variables");var d=b.index("by_iden").get(1);b.clear();d.onsuccess=function(){void 0==d.result?eval("object.put({iden: 1, "+a+": valor});"):eval("object.put({iden: 1,base:data.base,episodio:data.episodio, "+a+": valor});")};c()}var globalBase;
function getBase(a){var b=dataBase.result.transaction(["estados_variables"],"readwrite").objectStore("estados_variables").index("by_iden").get(1);b.onsuccess=function(){var c=b.result;globalBase=void 0!==c?c.base:"SB";a()}}function updatePageButtons(a,b){dataBase.result.transaction(["state_boton"],"readwrite").objectStore("state_boton").put({data_show:b,data_hide:a})}
function loadStateBoton(){var a=dataBase.result.transaction(["state_boton"],"readonly"),b=[];a.objectStore("state_boton").openCursor().onsuccess=function(a){a=a.target.result;null!==a&&(b.push(a.value),a["continue"]())};a.oncomplete=function(){for(var a in b)$("#"+b[a].data_show).show(),$("#"+b[a].data_hide).hide();for(a in b)$("div[id ^= "+b[a].data_show+"]").show(),$("div[id ^= "+b[a].data_hide+"]").hide();b=[]}}
function clearPageButtons(){dataBase.result.transaction(["state_boton"],"readwrite").objectStore("state_boton").clear()}var currentPage;function setPage(a,b){var c=dataBase.result.transaction(["page"],"readwrite").objectStore("page");c.clear();clearPageButtons();c.put({iden:1,actual:a,origen:b});currentPage=a;storeClave("R1","INS","NULL","NULL","NULL","NULL",function(){})}
function setPageWOR1(a,b){var c=dataBase.result.transaction(["page"],"readwrite").objectStore("page");c.clear();clearPageButtons();c.put({iden:1,actual:a,origen:b});currentPage=a}function setInitPage(a,b){var c=dataBase.result.transaction(["page"],"readwrite"),d=c.objectStore("page");d.clear();clearPageButtons();d.put({iden:1,actual:a,origen:a});c.oncomplete=function(){b()}}
function updatePage(a,b){var c=dataBase.result.transaction(["page"],"readwrite").objectStore("page"),d=c.index("by_iden").get(1);d.onsuccess=function(){var e=d.result;e.actual=a;e.origen=b;c.put(e);storeClave("R1","UPD","NULL","NULL","NULL","NULL",function(){})}}function storeTravel(a){var b=dataBase.result.transaction(["viaje"],"readwrite").objectStore("viaje");b.clear();b.put({iden:1,date:(new Date).getTime(),id_episodio:a.id_episodio,id_viaje:a.viaje.id_viaje})}
function clearTravel(){dataBase.result.transaction(["viaje"],"readwrite").objectStore("viaje").clear()}Date.prototype.toMysqlFormat=function(){return this.getFullYear()+"-"+twoDigits(1+this.getMonth())+"-"+twoDigits(this.getDate())+" "+twoDigits(this.getHours())+":"+twoDigits(this.getMinutes())+":"+twoDigits(this.getSeconds())};
function storeClave(a,b,c,d,e,n,p){var h=dataBase.result,f=h.transaction(["viaje"],"readwrite").objectStore("viaje").index("by_iden").get(1);f.onsuccess=function(){token(function(q){var k=f.result;if(void 0!==k){var l=h.transaction(["page"],"readwrite").objectStore("page").index("by_iden").get(1);l.onsuccess=function(){var g=l.result;if(void 0==g)setPageWOR1("regreso","regreso"),initEpisodioAuto();else{var g=g.actual,f=h.transaction(["claves"],"readwrite").objectStore("claves"),m=new Date;f.put({accurate:acc,
clave:a,estado1:b,estado2:c,estado3:d,estado4:e,timestamp:m.toMysqlFormat(),id_episodio:k.id_episodio,id_operador:id_operador,id_operador_unidad:id_operador_unidad,id_viaje:k.id_viaje,latitud:lat,longitud:lon,motivo:n,serie:serie,tiempo:m.toMysqlFormat(),token:q,origen:g,id_usuario:id_usuario});p()}}}else storeClave(a,b,c,d,e,"NULL",function(){}),getEpisode(function(){var a={};a.id_episodio=globalEpisodio;a.viaje={id_viaje:"IR003"};a=JSON.stringify(a);a=JSON.parse(a);storeTravel(a)})})}}
function setEpisodio(a){var b=dataBase.result.transaction(["viaje"],"readwrite").objectStore("viaje").index("by_iden").get(1);b.onsuccess=function(){setStoreVariable("episodio",b.result.id_episodio,function(){})};a()}var globalEpisodio;function getEpisode(a){var b=dataBase.result.transaction(["estados_variables"],"readwrite").objectStore("estados_variables").index("by_iden").get(1);b.onsuccess=function(){var c=b.result;globalEpisodio=void 0!==c?c.episodio:"0";a()}}
var last_lat=0,last_lon=0,acquiring=0;
function storeGps(a){distance=haversineDistance([last_lat,last_lon],[lat,lon]);(5<distance&&200>distance&&20>acc||25>acquiring)&&token(function(a){var b=dataBase.result.transaction(["gps"],"readwrite").objectStore("gps"),d=new Date;"undefined"==typeof acc&&"undefined"==typeof lat&&"undefined"==typeof lon&&console.log("indexedDB Ln 371 variables de geolocalizacion sin definir");b.put({latitud:lat,longitud:lon,tiempo:d.toMysqlFormat(),serie:serie,acurate:acc,cc:haversineDistance([last_lat,last_lon],
[lat,lon]),token:a});++acquiring});a()}function eliminarClave(a,b){dataBase.result.transaction([b],"readwrite").objectStore(b)["delete"](a)}function eliminarClaveByToken(a,b){var c=dataBase.result.transaction([b],"readwrite").objectStore(b).index("by_token").get(a);c.onsuccess=function(){var a=c.result;void 0!=a&&eliminarClave(a.id,b)}}function deleteDatabase(a){window.indexedDB.deleteDatabase(a)}startDB();var indexeddbLoaded=!0;